{
  "$schema": "https://railway.app/railway.schema.json",
  "build": {
    "builder": "nixpacks"
  },
  "deploy": {
    "numReplicas": 1,
    "restartPolicyType": "ON_FAILURE",
    "restartPolicyMaxRetries": 10
  },
  "services": [
    {
      "name": "frontend",
      "source": {
        "repo": ".",
        "ref": "main"
      },
      "build": {
        "buildCommand": "cd apps/frontend && npm install && npm run build",
        "watchPatterns": ["apps/frontend/**"]
      },
      "deploy": {
        "startCommand": "cd apps/frontend && npm run preview",
        "healthcheckPath": "/",
        "environmentVariables": {
          "PUBLIC_BACKEND_URL": "${{BACKEND_URL}}",
          "PUBLIC_STRIPE_KEY": "${{STRIPE_PUBLIC_KEY}}"
        }
      }
    },
    {
      "name": "backend",
      "source": {
        "repo": ".",
        "ref": "main"
      },
      "build": {
        "buildCommand": "cd apps/backend && pip install -r requirements.txt",
        "watchPatterns": ["apps/backend/**"]
      },
      "deploy": {
        "startCommand": "cd apps/backend && uvicorn src.soulseer.main:app --host 0.0.0.0 --port $PORT",
        "healthcheckPath": "/health",
        "environmentVariables": {
          "DATABASE_URL": "${{DATABASE_URL}}",
          "REDIS_URL": "${{REDIS_URL}}",
          "STRIPE_SECRET_KEY": "${{STRIPE_SECRET_KEY}}",
          "STRIPE_WEBHOOK_SIGNING_SECRET": "${{STRIPE_WEBHOOK_SIGNING_SECRET}}",
          "CLERK_SECRET_KEY": "${{CLERK_SECRET_KEY}}"
        }
      }
    }
  ]
}